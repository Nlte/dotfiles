#!/bin/sh

export DOTFILES_REPO="https://github.com/Nlte/dotfiles-stow.git"
export DOTFILES="$HOME/.dotfiles/"
cd "$DOTFILES" || exit 1

PATH="$(command -p getconf PATH):/usr/local/bin"

# load custom config if any
# shellcheck disable=SC1090
[ -f ~/.localrc ] && . ~/.localrc

# ssh would not work under cron, add a https one
echo "› setting up update channel"
git remote add updates $DOTFILE_REPO 2>/dev/null

# Update repo
echo "› git update"
git pull --rebase --stat updates "$(git rev-parse --abbrev-ref HEAD)"

# Update submodules
echo "› submodules update"
git submodule update --init --recursive --remote --merge --quiet

# Run all installs
echo "› $DOTFILES/script/install"
"$DOTFILES/script/install"

if command -v antibody >/dev/null 2>&1; then
	echo "› antibody update"
	antibody update
fi

echo "› registering last update"
git config --global dotfiles.lastupdate "$(date +%Y%m%d%H%M)"
